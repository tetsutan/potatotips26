<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- common.css -->
  <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: Arial, Helvetica, sans-serif;margin: 0;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 85%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
  <!-- ace-static.css -->
  <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
  <style>.ace-chrome .ace_gutter {background: #ebebeb;color: #333;overflow : hidden;}.ace-chrome .ace_print-margin {width: 1px;background: #e8e8e8;}.ace-chrome {background-color: #FFFFFF;color: black;}.ace-chrome .ace_cursor {color: black;}.ace-chrome .ace_invisible {color: rgb(191, 191, 191);}.ace-chrome .ace_constant.ace_buildin {color: rgb(88, 72, 246);}.ace-chrome .ace_constant.ace_language {color: rgb(88, 92, 246);}.ace-chrome .ace_constant.ace_library {color: rgb(6, 150, 14);}.ace-chrome .ace_invalid {background-color: rgb(153, 0, 0);color: white;}.ace-chrome .ace_fold {}.ace-chrome .ace_support.ace_function {color: rgb(60, 76, 114);}.ace-chrome .ace_support.ace_constant {color: rgb(6, 150, 14);}.ace-chrome .ace_support.ace_type,.ace-chrome .ace_support.ace_class.ace-chrome .ace_support.ace_other {color: rgb(109, 121, 222);}.ace-chrome .ace_variable.ace_parameter {font-style:italic;color:#FD971F;}.ace-chrome .ace_keyword.ace_operator {color: rgb(104, 118, 135);}.ace-chrome .ace_comment {color: #236e24;}.ace-chrome .ace_comment.ace_doc {color: #236e24;}.ace-chrome .ace_comment.ace_doc.ace_tag {color: #236e24;}.ace-chrome .ace_constant.ace_numeric {color: rgb(0, 0, 205);}.ace-chrome .ace_variable {color: rgb(49, 132, 149);}.ace-chrome .ace_xml-pe {color: rgb(104, 104, 91);}.ace-chrome .ace_entity.ace_name.ace_function {color: #0000A2;}.ace-chrome .ace_heading {color: rgb(12, 7, 255);}.ace-chrome .ace_list {color:rgb(185, 6, 144);}.ace-chrome .ace_marker-layer .ace_selection {background: rgb(181, 213, 255);}.ace-chrome .ace_marker-layer .ace_step {background: rgb(252, 255, 0);}.ace-chrome .ace_marker-layer .ace_stack {background: rgb(164, 229, 101);}.ace-chrome .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgb(192, 192, 192);}.ace-chrome .ace_marker-layer .ace_active-line {background: rgba(0, 0, 0, 0.07);}.ace-chrome .ace_gutter-active-line {background-color : #dcdcdc;}.ace-chrome .ace_marker-layer .ace_selected-word {background: rgb(250, 250, 255);border: 1px solid rgb(200, 200, 250);}.ace-chrome .ace_storage,.ace-chrome .ace_keyword,.ace-chrome .ace_meta.ace_tag {color: rgb(147, 15, 128);}.ace-chrome .ace_string.ace_regex {color: rgb(255, 0, 0)}.ace-chrome .ace_string {color: #1A1AA6;}.ace-chrome .ace_entity.ace_other.ace_attribute-name {color: #994409;}.ace-chrome .ace_indent-guide {background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAE0lEQVQImWP4////f4bLly//BwAmVgd1/w11/gAAAABJRU5ErkJggg==") right repeat-y;}</style>
  <!-- export.css -->
  <style>
    body{margin:0 auto;max-width:800px;line-height:1.4}
    #nav{margin:5px 0 10px;font-size:15px}
    #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
    #contentarea{font-size:15px;margin:16px 0}
    .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
    .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
    .latex-cell{white-space:pre-wrap;}
  </style>
  <!-- User CSS -->
  <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
</head>
<body>
  
  <div id="titlearea">
    <h2>Potatotips26</h2>
  </div>
  <div id="contentarea"><div class="cell markdown-cell"><h2 id="-">フラグメント移動後に前のフラグメントのデータが次のフラグメントに表示されたので調査したはなし</h2>
</div><div class="cell text-cell">Tipsというよりコードリーディングの結果の話<div>あくまで可能性の話</div></div><div class="cell diagram-cell"><svg height="250" version="1.1" width="734.53125" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; top: -0.84375px;"><desc>Created with Raphaël 2.1.2</desc><defs><path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block"></path><marker id="raphael-marker-endblock55-obj141" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use NS1:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker><marker id="raphael-marker-endblock55-obj144" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use NS2:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker><marker id="raphael-marker-endblock55-obj147" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use NS3:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker></defs><rect x="10" y="20" width="173.625" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="20" y="30" width="153.625" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="96.8125" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">FragmentActivity</tspan></text><rect x="10" y="192" width="173.625" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="20" y="202" width="153.625" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="96.8125" y="211" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">FragmentActivity</tspan></text><path fill="none" stroke="#000000" d="M96.8125,58L96.8125,192" stroke-width="2" style=""></path><rect x="203.625" y="20" width="192.84375" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="213.625" y="30" width="172.84375" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="300.046875" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">FragmentController</tspan></text><rect x="203.625" y="192" width="192.84375" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="213.625" y="202" width="172.84375" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="300.046875" y="211" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">FragmentController</tspan></text><path fill="none" stroke="#000000" d="M300.046875,58L300.046875,192" stroke-width="2" style=""></path><rect x="492.5" y="20" width="212.03125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="502.5" y="30" width="192.03125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="598.515625" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">FragmentHostCallback</tspan></text><rect x="492.5" y="192" width="212.03125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="502.5" y="202" width="192.03125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="598.515625" y="211" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">FragmentHostCallback</tspan></text><path fill="none" stroke="#000000" d="M598.515625,58L598.515625,192" stroke-width="2" style=""></path><rect x="121.609375" y="74" width="153.640625" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="198.4296875" y="83" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">createController</tspan></text><path fill="none" stroke="#000000" d="M96.8125,96C96.8125,96,263.816613628529,96,295.0483399565205,96" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj141)" stroke-dasharray="0" style=""></path><rect x="310.046875" y="112" width="278.46875" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="449.28125" y="121" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">mHost.getFragmentManagerImple</tspan></text><path fill="none" stroke="#000000" d="M300.046875,134C300.046875,134,554.5083380267024,134,593.5224490571636,134" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj144)" stroke-dasharray="0" style=""></path><rect x="189.234375" y="150" width="316.859375" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="347.6640625" y="159" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">mFragmentManager: FragmentManager</tspan></text><path fill="none" stroke="#000000" d="M598.515625,172C598.515625,172,154.11396245937794,172,101.81864963111138,172" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj147)" stroke-dasharray="6,2" style=""></path></svg></div><div class="cell diagram-cell"><svg height="212" version="1.1" width="388.0625" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; top: -0.84375px;"><desc>Created with Raphaël 2.1.2</desc><defs><marker id="raphael-marker-endblock55-obj168" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use NS4:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker><marker id="raphael-marker-endblock55-obj171" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use NS5:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker></defs><rect x="10" y="20" width="164.03125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="20" y="30" width="144.03125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="92.015625" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">FragmentManager</tspan></text><rect x="10" y="154" width="164.03125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="20" y="164" width="144.03125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="92.015625" y="173" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">FragmentManager</tspan></text><path fill="none" stroke="#000000" d="M92.015625,58L92.015625,154" stroke-width="2" style=""></path><rect x="194.03125" y="20" width="164.03125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="204.03125" y="30" width="144.03125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="276.046875" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">BackStackRecord</tspan></text><rect x="194.03125" y="154" width="164.03125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="204.03125" y="164" width="144.03125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="276.046875" y="173" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">BackStackRecord</tspan></text><path fill="none" stroke="#000000" d="M276.046875,58L276.046875,154" stroke-width="2" style=""></path><rect x="107.21875" y="74" width="153.625" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="184.03125" y="83" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">beginTransaction</tspan></text><path fill="none" stroke="#000000" d="M92.015625,96C92.015625,96,241.61517782695591,96,271.0529804584321,96" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj168)" stroke-dasharray="0" style=""></path><rect x="116.8125" y="112" width="134.4375" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="184.03125" y="121" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">commitInternal</tspan></text><path fill="none" stroke="#000000" d="M276.046875,134C276.046875,134,126.44732217304409,134,97.0095195415679,134" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj171)" stroke-dasharray="6,2" style=""></path></svg></div><div class="cell markdown-cell"><h3 id="-fragment-v4-support-state-view-">ここから長々とFragment(v4.support)とはState付きのViewであるという話をします。</h3>
</div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;"># BackStackRecord.java</span></pre><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">int </span><span style="color:#ffc66d;">commitInternal</span>(<span style="color:#cc7832;">boolean </span>allowStateLoss) {<br>    <span style="color:#cc7832;">if </span>(<span style="color:#9876aa;">mCommitted</span>) <span style="color:#cc7832;">throw new </span>IllegalStateException(<span style="color:#6a8759;">"commit already called"</span>)<span style="color:#cc7832;">;<br></span><br>    <span style="color:#9876aa;">mCommitted </span>= <span style="color:#cc7832;">true;<br></span><span style="color:#cc7832;">    if </span>(<span style="color:#9876aa;">mAddToBackStack</span>) {<br>        <span style="color:#9876aa;">mIndex </span>= <span style="color:#9876aa;">mManager</span>.allocBackStackIndex(<span style="color:#cc7832;">this</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>} <span style="color:#cc7832;">else </span>{<br>        <span style="color:#9876aa;">mIndex </span>= -<span style="color:#6897bb;">1</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>}<br>    <span style="color:#9876aa;">mManager</span>.enqueueAction(<span style="color:#cc7832;">this, </span>allowStateLoss)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    return </span><span style="color:#9876aa;">mIndex</span><span style="color:#cc7832;">;<br></span>}</pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;"># FragmentManager.java</span></pre><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">public void </span><span style="color:#ffc66d;">enqueueAction</span>(Runnable action<span style="color:#cc7832;">, boolean </span>allowStateLoss) {<br>    <span style="color:#cc7832;">if </span>(!allowStateLoss) {<br>        checkStateLoss()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>}<br>    <span style="color:#cc7832;">synchronized </span>(<span style="color:#cc7832;">this</span>) {<br>        <span style="color:#cc7832;">if </span>(<span style="color:#9876aa;">mDestroyed </span>|| <span style="color:#9876aa;">mHost </span>== <span style="color:#cc7832;">null</span>) {<br>            <span style="color:#cc7832;">throw new </span>IllegalStateException(<span style="color:#6a8759;">"Activity has been destroyed"</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>}<br>        <span style="color:#cc7832;">if </span>(<span style="color:#9876aa;">mPendingActions </span>== <span style="color:#cc7832;">null</span>) {<br>            <span style="color:#9876aa;">mPendingActions </span>= <span style="color:#cc7832;">new </span>ArrayList&lt;Runnable&gt;()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>}<br>        <span style="color:#9876aa;">mPendingActions</span>.add(action)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        if </span>(<span style="color:#9876aa;">mPendingActions</span>.size() == <span style="color:#6897bb;">1</span>) {<br>            <span style="color:#9876aa;">mHost</span>.getHandler().removeCallbacks(<span style="color:#9876aa;">mExecCommit</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">mHost</span>.getHandler().post(<span style="color:#9876aa;">mExecCommit</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>}<br>    }<br>}</pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;">Runnable <span style="color:#9876aa;">mExecCommit </span>= <span style="color:#cc7832;">new </span>Runnable() {<br>    <span style="color:#bbb529;">@Override<br></span><span style="color:#bbb529;">    </span><span style="color:#cc7832;">public void </span><span style="color:#ffc66d;">run</span>() {<br>        execPendingActions()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>}<br>}<span style="color:#cc7832;">;</span></pre></div><div class="cell text-cell">enqueueActionで mPendingActionsに追加して、 Handler で post(mExecCommit) して実行</div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#629755;font-style:italic;">/**<br></span><span style="color:#629755;font-style:italic;"> * Only call from main thread!<br></span><span style="color:#629755;font-style:italic;"> */<br></span><span style="color:#cc7832;">public boolean </span><span style="color:#ffc66d;">execPendingActions</span>() {<br>    <span style="color:#cc7832;">if </span>(<span style="color:#9876aa;">mExecutingActions</span>) {<br>        <span style="color:#cc7832;">throw new </span>IllegalStateException(<span style="color:#6a8759;">"Recursive entry to executePendingTransactions"</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>}<br>    <br>    <span style="color:#cc7832;">if </span>(Looper.<span style="font-style:italic;">myLooper</span>() != <span style="color:#9876aa;">mHost</span>.getHandler().getLooper()) {<br>        <span style="color:#cc7832;">throw new </span>IllegalStateException(<span style="color:#6a8759;">"Must be called from main thread of process"</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>}<br><br>    <span style="color:#cc7832;">boolean </span>didSomething = <span style="color:#cc7832;">false;<br></span><span style="color:#cc7832;"><br></span><span style="color:#cc7832;">    while </span>(<span style="color:#cc7832;">true</span>) {<br>        <span style="color:#cc7832;">int </span>numActions<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        <br></span><span style="color:#cc7832;">        synchronized </span>(<span style="color:#cc7832;">this</span>) {<br>            <span style="color:#cc7832;">if </span>(<span style="color:#9876aa;">mPendingActions </span>== <span style="color:#cc7832;">null </span>|| <span style="color:#9876aa;">mPendingActions</span>.size() == <span style="color:#6897bb;">0</span>) {<br>                <span style="color:#cc7832;">break;<br></span><span style="color:#cc7832;">            </span>}<br>            <br>            numActions = <span style="color:#9876aa;">mPendingActions</span>.size()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            if </span>(<span style="color:#9876aa;">mTmpActions </span>== <span style="color:#cc7832;">null </span>|| <span style="color:#9876aa;">mTmpActions</span>.<span style="color:#9876aa;">length </span>&lt; numActions) {<br>                <span style="color:#9876aa;">mTmpActions </span>= <span style="color:#cc7832;">new </span>Runnable[numActions]<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span>}<br>            <span style="color:#9876aa;">mPendingActions</span>.toArray(<span style="color:#9876aa;">mTmpActions</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">mPendingActions</span>.clear()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">mHost</span>.getHandler().removeCallbacks(<span style="color:#9876aa;">mExecCommit</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>}<br>        <br>        <span style="color:#9876aa;">mExecutingActions </span>= <span style="color:#cc7832;">true;<br></span><span style="color:#cc7832;">        for </span>(<span style="color:#cc7832;">int </span>i=<span style="color:#6897bb;">0</span><span style="color:#cc7832;">; </span>i&lt;numActions<span style="color:#cc7832;">; </span>i++) {<br>            <span style="color:#9876aa;">mTmpActions</span>[i].run()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">mTmpActions</span>[i] = <span style="color:#cc7832;">null;<br></span><span style="color:#cc7832;">        </span>}<br>        <span style="color:#9876aa;">mExecutingActions </span>= <span style="color:#cc7832;">false;<br></span><span style="color:#cc7832;">        </span>didSomething = <span style="color:#cc7832;">true;<br></span><span style="color:#cc7832;">    </span>}<br>    <br>    <span style="color:#cc7832;">if </span>(<span style="color:#9876aa;">mHavePendingDeferredStart</span>) {<br>        <span style="color:#cc7832;">boolean </span>loadersRunning = <span style="color:#cc7832;">false;<br></span><span style="color:#cc7832;">        for </span>(<span style="color:#cc7832;">int </span>i=<span style="color:#6897bb;">0</span><span style="color:#cc7832;">; </span>i&lt;<span style="color:#9876aa;">mActive</span>.size()<span style="color:#cc7832;">; </span>i++) {<br>            Fragment f = <span style="color:#9876aa;">mActive</span>.get(i)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            if </span>(f != <span style="color:#cc7832;">null </span>&amp;&amp; f.<span style="color:#9876aa;">mLoaderManager </span>!= <span style="color:#cc7832;">null</span>) {<br>                loadersRunning |= f.<span style="color:#9876aa;">mLoaderManager</span>.hasRunningLoaders()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span>}<br>        }<br>        <span style="color:#cc7832;">if </span>(!loadersRunning) {<br>            <span style="color:#9876aa;">mHavePendingDeferredStart </span>= <span style="color:#cc7832;">false;<br></span><span style="color:#cc7832;">            </span>startPendingDeferredFragments()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>}<br>    }<br>    <span style="color:#cc7832;">return </span>didSomething<span style="color:#cc7832;">;<br></span>}</pre></div><div class="cell text-cell">肝心のmPendingActionsのはRunnalbeで、100行くらい有ります</div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">case </span><span style="color:#9876aa;font-style:italic;">OP_REPLACE</span>: {<br>    Fragment f = op.<span style="color:#9876aa;">fragment</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    int </span>containerId = f.<span style="color:#9876aa;">mContainerId</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    if </span>(<span style="color:#9876aa;">mManager</span>.<span style="color:#9876aa;">mAdded </span>!= <span style="color:#cc7832;">null</span>) {<br>        <span style="color:#cc7832;">for </span>(<span style="color:#cc7832;">int </span>i=<span style="color:#6897bb;">0</span><span style="color:#cc7832;">; </span>i&lt;<span style="color:#9876aa;">mManager</span>.<span style="color:#9876aa;">mAdded</span>.size()<span style="color:#cc7832;">; </span>i++) {<br>            Fragment old = <span style="color:#9876aa;">mManager</span>.<span style="color:#9876aa;">mAdded</span>.get(i)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            if </span>(FragmentManagerImpl.<span style="color:#9876aa;font-style:italic;">DEBUG</span>) Log.<span style="font-style:italic;">v</span>(<span style="color:#9876aa;font-style:italic;">TAG</span><span style="color:#cc7832;">,<br></span><span style="color:#cc7832;">                    </span><span style="color:#6a8759;">"OP_REPLACE: adding=" </span>+ f + <span style="color:#6a8759;">" old=" </span>+ old)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            if </span>(old.<span style="color:#9876aa;">mContainerId </span>== containerId) {<br>                <span style="color:#cc7832;">if </span>(old == f) {<br>                    op.<span style="color:#9876aa;">fragment </span>= f = <span style="color:#cc7832;">null;<br></span><span style="color:#cc7832;">                </span>} <span style="color:#cc7832;">else </span>{<br>                    <span style="color:#cc7832;">if </span>(op.<span style="color:#9876aa;">removed </span>== <span style="color:#cc7832;">null</span>) {<br>                        op.<span style="color:#9876aa;">removed </span>= <span style="color:#cc7832;">new </span>ArrayList&lt;Fragment&gt;()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">                    </span>}<br>                    op.<span style="color:#9876aa;">removed</span>.add(old)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">                    </span>old.<span style="color:#9876aa;">mNextAnim </span>= exitAnim<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">                    if </span>(<span style="color:#9876aa;">mAddToBackStack</span>) {<br>                        old.<span style="color:#9876aa;">mBackStackNesting </span>+= <span style="color:#6897bb;">1</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">                        if </span>(FragmentManagerImpl.<span style="color:#9876aa;font-style:italic;">DEBUG</span>) Log.<span style="font-style:italic;">v</span>(<span style="color:#9876aa;font-style:italic;">TAG</span><span style="color:#cc7832;">, </span><span style="color:#6a8759;">"Bump nesting of "<br></span><span style="color:#6a8759;">                                </span>+ old + <span style="color:#6a8759;">" to " </span>+ old.<span style="color:#9876aa;">mBackStackNesting</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">                    </span>}<br>                    <span style="color:#9876aa;">mManager</span>.removeFragment(old<span style="color:#cc7832;">, </span>transition<span style="color:#cc7832;">, </span>transitionStyle)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">                </span>}<br>            }<br>        }<br>    }<br>    <span style="color:#cc7832;">if </span>(f != <span style="color:#cc7832;">null</span>) {<br>        f.<span style="color:#9876aa;">mNextAnim </span>= enterAnim<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span><span style="color:#9876aa;">mManager</span>.addFragment(f<span style="color:#cc7832;">, false</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>}<br>} <span style="color:#cc7832;">break;</span></pre></div><div class="cell text-cell">FragmentはmContainer:ViewGroup で全体のViewを管理しています。ViewをFragmentと同じ動作にみせかけます</div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#808080;">// When a fragment is being dynamically added to the view hierarchy, this<br></span><span style="color:#808080;">// is the identifier of the parent container it is being added to.<br></span><span style="color:#cc7832;">int </span><span style="color:#9876aa;">mContainerId</span><span style="color:#cc7832;">;</span></pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">static final class </span>Op {<br>    Op <span style="color:#9876aa;">next</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>Op <span style="color:#9876aa;">prev</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    int </span><span style="color:#9876aa;">cmd</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>Fragment <span style="color:#9876aa;">fragment</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    int </span><span style="color:#9876aa;">enterAnim</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    int </span><span style="color:#9876aa;">exitAnim</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    int </span><span style="color:#9876aa;">popEnterAnim</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    int </span><span style="color:#9876aa;">popExitAnim</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>ArrayList&lt;Fragment&gt; <span style="color:#9876aa;">removed</span><span style="color:#cc7832;">;<br></span>}</pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">case </span><span style="color:#9876aa;font-style:italic;">OP_ATTACH</span>: {<br>    Fragment f = op.<span style="color:#9876aa;">fragment</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>f.<span style="color:#9876aa;">mNextAnim </span>= enterAnim<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span><span style="color:#9876aa;">mManager</span>.attachFragment(f<span style="color:#cc7832;">, </span>transition<span style="color:#cc7832;">, </span>transitionStyle)<span style="color:#cc7832;">;<br></span>} <span style="color:#cc7832;">break;</span></pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">public void </span><span style="color:#ffc66d;">attachFragment</span>(Fragment fragment<span style="color:#cc7832;">, int </span>transition<span style="color:#cc7832;">, int </span>transitionStyle) {<span style="color:#cc7832;"><br></span><span style="color:#cc7832;">    if </span>(fragment.<span style="color:#9876aa;">mDetached</span>) {<br>        fragment.<span style="color:#9876aa;">mDetached </span>= <span style="color:#cc7832;">false;<br></span><span style="color:#cc7832;">        if </span>(!fragment.<span style="color:#9876aa;">mAdded</span>) {<br>            <span style="color:#cc7832;">if </span>(<span style="color:#9876aa;">mAdded </span>== <span style="color:#cc7832;">null</span>) {<br>                <span style="color:#9876aa;">mAdded </span>= <span style="color:#cc7832;">new </span>ArrayList&lt;Fragment&gt;()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span>}<br>            <span style="color:#cc7832;">if </span>(<span style="color:#9876aa;">mAdded</span>.contains(fragment)) {<br>                <span style="color:#cc7832;">throw new </span>IllegalStateException(<span style="color:#6a8759;">"Fragment already added: " </span>+ fragment)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span>}<span style="color:#cc7832;"><br></span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">mAdded</span>.add(fragment)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span>fragment.<span style="color:#9876aa;">mAdded </span>= <span style="color:#cc7832;">true;<br></span><span style="color:#cc7832;">            if </span>(fragment.<span style="color:#9876aa;">mHasMenu </span>&amp;&amp; fragment.<span style="color:#9876aa;">mMenuVisible</span>) {<br>                <span style="color:#9876aa;">mNeedMenuInvalidate </span>= <span style="color:#cc7832;">true;<br></span><span style="color:#cc7832;">            </span>}<br>            moveToState(fragment<span style="color:#cc7832;">, </span><span style="color:#9876aa;">mCurState</span><span style="color:#cc7832;">, </span>transition<span style="color:#cc7832;">, </span>transitionStyle<span style="color:#cc7832;">, false</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>}<br>    }<br>}</pre></div><div class="cell text-cell">moveToStateではstateという値をゴニョゴニョしてる</div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">static final int </span><span style="color:#9876aa;font-style:italic;">INITIALIZING </span>= <span style="color:#6897bb;">0</span><span style="color:#cc7832;">;     </span><span style="color:#808080;">// Not yet created.<br></span><span style="color:#cc7832;">static final int </span><span style="color:#9876aa;font-style:italic;">CREATED </span>= <span style="color:#6897bb;">1</span><span style="color:#cc7832;">;          </span><span style="color:#808080;">// Created.<br></span><span style="color:#cc7832;">static final int </span><span style="color:#9876aa;font-style:italic;">ACTIVITY_CREATED </span>= <span style="color:#6897bb;">2</span><span style="color:#cc7832;">; </span><span style="color:#808080;">// The activity has finished its creation.<br></span><span style="color:#cc7832;">static final int </span><span style="color:#9876aa;font-style:italic;">STOPPED </span>= <span style="color:#6897bb;">3</span><span style="color:#cc7832;">;          </span><span style="color:#808080;">// Fully created, not started.<br></span><span style="color:#cc7832;">static final int </span><span style="color:#9876aa;font-style:italic;">STARTED </span>= <span style="color:#6897bb;">4</span><span style="color:#cc7832;">;          </span><span style="color:#808080;">// Created and started, not resumed.<br></span><span style="color:#cc7832;">static final int </span><span style="color:#9876aa;font-style:italic;">RESUMED </span>= <span style="color:#6897bb;">5</span><span style="color:#cc7832;">;          </span><span style="color:#808080;">// Created started and resumed.<br></span><span style="color:#808080;"><br></span><span style="color:#cc7832;">int </span><span style="color:#9876aa;">mState </span>= <span style="color:#9876aa;font-style:italic;">INITIALIZING</span><span style="color:#cc7832;">;</span></pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">case </span>Fragment.<span style="color:#9876aa;font-style:italic;">STARTED</span>:<br>    <span style="color:#cc7832;">if </span>(newState &gt; Fragment.<span style="color:#9876aa;font-style:italic;">STARTED</span>) {<br>        <span style="color:#cc7832;">if </span>(<span style="color:#9876aa;font-style:italic;">DEBUG</span>) Log.<span style="font-style:italic;">v</span>(<span style="color:#9876aa;font-style:italic;">TAG</span><span style="color:#cc7832;">, </span><span style="color:#6a8759;">"moveto RESUMED: " </span>+ f)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>f.<span style="color:#9876aa;">mResumed </span>= <span style="color:#cc7832;">true;<br></span><span style="color:#cc7832;">        </span>f.performResume()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>f.<span style="color:#9876aa;">mSavedFragmentState </span>= <span style="color:#cc7832;">null;<br></span><span style="color:#cc7832;">        </span>f.<span style="color:#9876aa;">mSavedViewState </span>= <span style="color:#cc7832;">null;</span></pre></div><div class="cell text-cell">今のFragmentがSTARTED stateで、次のリクエストされたstateが STARTED以上ならperfomeResumeを呼ぶ</div><div class="cell markdown-cell"><h3 id="-listview-and-adapter">続いてListView and Adapter</h3>
</div><div class="cell diagram-cell"><svg height="176" version="1.1" width="428.0625" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; top: -0.34375px;"><desc>Created with Raphaël 2.1.2</desc><defs><marker id="raphael-marker-endblock55-obj200" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use NS6:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker><marker id="raphael-marker-endblock55-obj203" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use NS7:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker></defs><rect x="10" y="20" width="96.8125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="20" y="30" width="76.8125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="58.40625" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">ListView</tspan></text><rect x="10" y="118" width="96.8125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="20" y="128" width="76.8125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="58.40625" y="137" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">ListView</tspan></text><path fill="none" stroke="#000000" d="M58.40625,58L58.40625,118" stroke-width="2" style=""></path><rect x="126.8125" y="20" width="125.625" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="136.8125" y="30" width="105.625" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="189.625" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">AbsListView</tspan></text><rect x="126.8125" y="118" width="125.625" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="136.8125" y="128" width="105.625" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="189.625" y="137" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">AbsListView</tspan></text><path fill="none" stroke="#000000" d="M189.625,58L189.625,118" stroke-width="2" style=""></path><rect x="272.4375" y="20" width="125.625" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="282.4375" y="30" width="105.625" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="335.25" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">AdapterView</tspan></text><rect x="272.4375" y="118" width="125.625" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="282.4375" y="128" width="105.625" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="335.25" y="137" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">AdapterView</tspan></text><path fill="none" stroke="#000000" d="M335.25,58L335.25,118" stroke-width="2" style=""></path><rect x="0" y="0" width="0" height="0" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="124.015625" y="83" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="83"></tspan></text><path fill="none" stroke="#000000" d="M58.40625,78C58.40625,78,160.61606533639133,78,184.62139794225277,78" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj200)" stroke-dasharray="0" style=""></path><rect x="0" y="0" width="0" height="0" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="262.4375" y="103" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="103"></tspan></text><path fill="none" stroke="#000000" d="M189.625,98C189.625,98,304.6937513127923,98,330.25834205855426,98" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj203)" stroke-dasharray="0" style=""></path></svg></div><div class="cell diagram-cell"><svg height="156" version="1.1" width="359.28125" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; top: -0.34375px;"><desc>Created with Raphaël 2.1.2</desc><defs><marker id="raphael-marker-endblock55-obj223" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use NS8:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker></defs><rect x="10" y="20" width="116.03125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="20" y="30" width="96.03125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="68.015625" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">RenderNode</tspan></text><rect x="10" y="98" width="116.03125" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="20" y="108" width="96.03125" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="68.015625" y="117" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">RenderNode</tspan></text><path fill="none" stroke="#000000" d="M68.015625,58L68.015625,98" stroke-width="2" style=""></path><rect x="146.03125" y="20" width="183.25" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="156.03125" y="30" width="163.25" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="237.65625" y="39" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">DisplayListCanvas</tspan></text><rect x="146.03125" y="98" width="183.25" height="38" rx="0" ry="0" fill="none" stroke="#000000" stroke-width="2" style=""></rect><rect x="156.03125" y="108" width="163.25" height="18" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="237.65625" y="117" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="5.515625">DisplayListCanvas</tspan></text><path fill="none" stroke="#000000" d="M237.65625,58L237.65625,98" stroke-width="2" style=""></path><rect x="0" y="0" width="0" height="0" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text x="152.8359375" y="83" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000" style="text-anchor: middle; font-family: 'Andale Mono', monospace; font-size: 16px;"><tspan dy="83"></tspan></text><path fill="none" stroke="#000000" d="M68.015625,78C68.015625,78,204.57598555181175,78,232.64820810665196,78" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj223)" stroke-dasharray="0" style=""></path></svg></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"># ListView#setAdapter</pre><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;">mDataSetObserver = <span style="color:#cc7832;">new </span>AdapterDataSetObserver()<span style="color:#cc7832;">;<br></span>mAdapter.registerDataSetObserver(mDataSetObserver)<span style="color:#cc7832;">;</span></pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">public void </span><span style="color:#ffc66d;">notifyChanged</span>() {<br>    <span style="color:#cc7832;">synchronized</span>(<span style="color:#9876aa;">mObservers</span>) {<br>        <span style="color:#808080;">// since onChanged() is implemented by the app, it could do anything, including<br></span><span style="color:#808080;">        // removing itself from {@link mObservers} - and that could cause problems if<br></span><span style="color:#808080;">        // an iterator is used on the ArrayList {@link mObservers}.<br></span><span style="color:#808080;">        // to avoid such problems, just march thru the list in the reverse order.<br></span><span style="color:#808080;">        </span><span style="color:#cc7832;">for </span>(<span style="color:#cc7832;">int </span>i = <span style="color:#9876aa;">mObservers</span>.size() - <span style="color:#6897bb;">1</span><span style="color:#cc7832;">; </span>i &gt;= <span style="color:#6897bb;">0</span><span style="color:#cc7832;">; </span>i--) {<br>            <span style="color:#9876aa;">mObservers</span>.get(i).onChanged()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>}<br>    }<br>}</pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:8.3pt;"><span style="color:#cc7832;"># AdapterView.java</span></pre><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:8.3pt;"><span style="color:#cc7832;">class </span>AdapterDataSetObserver <span style="color:#cc7832;">extends </span>DataSetObserver {<br><br>    <span style="color:#cc7832;">private </span>Parcelable mInstanceState = <span style="color:#cc7832;">null;<br></span><span style="color:#cc7832;"><br></span><span style="color:#cc7832;">    </span>@Override<br>    <span style="color:#cc7832;">public void </span>onChanged() {<br>        mDataChanged = <span style="color:#cc7832;">true;<br></span><span style="color:#cc7832;">        </span>mOldItemCount = mItemCount<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>mItemCount = getAdapter().getCount()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;"><br></span><span style="color:#cc7832;">        </span><span style="color:#808080;">// Detect the case where a cursor that was previously invalidated has<br></span><span style="color:#808080;">        // been repopulated with new data.<br></span><span style="color:#808080;">        </span><span style="color:#cc7832;">if </span>(AdapterView.<span style="color:#cc7832;">this</span>.getAdapter().hasStableIds() &amp;&amp; mInstanceState != <span style="color:#cc7832;">null<br></span><span style="color:#cc7832;">                </span>&amp;&amp; mOldItemCount == <span style="color:#6897bb;">0 </span>&amp;&amp; mItemCount &gt; <span style="color:#6897bb;">0</span>) {<br>            AdapterView.<span style="color:#cc7832;">this</span>.onRestoreInstanceState(mInstanceState)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">            </span>mInstanceState = <span style="color:#cc7832;">null;<br></span><span style="color:#cc7832;">        </span>} <span style="color:#cc7832;">else </span>{<br>            rememberSyncState()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>}<br>        checkFocus()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>requestLayout()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>}<br><br>    @Override<br>    <span style="color:#cc7832;">public void </span>onInvalidated() {<br>        mDataChanged = <span style="color:#cc7832;">true;<br></span><span style="color:#cc7832;"><br></span><span style="color:#cc7832;">        if </span>(AdapterView.<span style="color:#cc7832;">this</span>.getAdapter().hasStableIds()) {<br>            <span style="color:#808080;">// Remember the current state for the case where our hosting activity is being<br></span><span style="color:#808080;">            // stopped and later restarted<br></span><span style="color:#808080;">            </span>mInstanceState = AdapterView.<span style="color:#cc7832;">this</span>.onSaveInstanceState()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>}<br><br>        <span style="color:#808080;">// Data is invalid so we should reset our state<br></span><span style="color:#808080;">        </span>mOldItemCount = mItemCount<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>mItemCount = <span style="color:#6897bb;">0</span><span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>mSelectedPosition = INVALID_POSITION<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>mSelectedRowId = INVALID_ROW_ID<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>mNextSelectedPosition = INVALID_POSITION<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>mNextSelectedRowId = INVALID_ROW_ID<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>mNeedSync = <span style="color:#cc7832;">false;<br></span><span style="color:#cc7832;"><br></span><span style="color:#cc7832;">        </span>checkFocus()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">        </span>requestLayout()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>}<br><br>    <span style="color:#cc7832;">public void </span>clearSavedState() {<br>        mInstanceState = <span style="color:#cc7832;">null;<br></span><span style="color:#cc7832;">    </span>}<br>}</pre></div><div class="cell text-cell">ではdrawはどういうコールのされ方でしょう</div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">protected void </span><span style="color:#ffc66d;">dispatchDraw</span>(Canvas <span style="background-color:#344134;">canvas</span>) {</pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">final </span><span style="background-color:#344134;">DisplayListCanvas</span> canvas = renderNode.start(width<span style="color:#cc7832;">, </span>height)<span style="color:#cc7832;">;</span></pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="background-color:#40332b;">mRenderNode</span> = RenderNode.<span style="font-style:italic;">create</span>(getClass().getName()<span style="color:#cc7832;">, this</span>)<span style="color:#cc7832;">;</span></pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">public static </span>RenderNode <span style="color:#ffc66d;">create</span>(String name<span style="color:#cc7832;">, </span>@Nullable View owningView) {<br>    <span style="color:#cc7832;">return new </span>RenderNode(name<span style="color:#cc7832;">, </span>owningView)<span style="color:#cc7832;">;<br></span>}</pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:9.0pt;"><span style="color:#cc7832;">public </span>DisplayListCanvas <span style="color:#ffc66d;">start</span>(<span style="color:#cc7832;">int </span>width<span style="color:#cc7832;">, int </span>height) {<br>    DisplayListCanvas canvas = DisplayListCanvas.<span style="font-style:italic;">obtain</span>(<span style="color:#cc7832;">this</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span>canvas.setViewport(width<span style="color:#cc7832;">, </span>height)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    </span><span style="color:#808080;">// The dirty rect should always be null for a display list<br></span><span style="color:#808080;">    </span>canvas.onPreDraw(<span style="color:#cc7832;">null</span>)<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    return </span>canvas<span style="color:#cc7832;">;<br></span>}</pre></div><div class="cell text-cell"><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:8.3pt;"><span style="color:#cc7832;"># View.java</span></pre><pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Ricty Discord';font-size:8.3pt;"><span style="color:#cc7832;">if </span>(drawingWithRenderNode) {<br>    <span style="color:#808080;">// Delay getting the display list until animation-driven alpha values are<br></span><span style="color:#808080;">    // set up and possibly passed on to the view<br></span><span style="color:#808080;">    </span>renderNode = updateDisplayListIfDirty()<span style="color:#cc7832;">;<br></span><span style="color:#cc7832;">    if </span>(!renderNode.isValid()) {<br>        <span style="color:#808080;">// Uncommon, but possible. If a view is removed from the hierarchy during the call<br></span><span style="color:#808080;">        // to getDisplayList(), the display list will be marked invalid and we should not<br></span><span style="color:#808080;">        // try to use it again.<br></span><span style="color:#808080;">        </span>renderNode = <span style="color:#cc7832;">null;<br></span><span style="color:#cc7832;">        </span>drawingWithRenderNode = <span style="color:#cc7832;">false;<br></span><span style="color:#cc7832;">    </span>}<br>}</pre></div><div class="cell markdown-cell"><h3 id="-updatedisplaylistifdirty-canvas-rendernode-destroydisplaylistdata-">結論： <code>updateDisplayListIfDirty()</code> を呼び出してcanvasにレンダリングしている間に ビューがツリーから削除されたけど、<code>renderNode</code>の<code>destroyDisplayListData()</code> が呼ばれる前だった（という予想）</h3>
</div><div class="cell text-cell"></div><div class="cell text-cell"></div></div>
  <script></script>
</body>
</html>